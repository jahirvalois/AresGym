<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MSAL Redirect Handler</title>
  </head>
  <body>
    <p>Processing sign-in...</p>
    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <script>
      (function(){
        try {
          const redirectUri = window.location.origin + '/msal_redirect.html';
          // Try to get clientId from injected runtime var or query param
          let clientId = (window.__VITE_MICROSOFT_CLIENT_ID || '') || (new URLSearchParams(location.search).get('clientId') || '');

          const initWithClientId = (cid) => {
            try {
              const pca = new msal.PublicClientApplication({ auth: { clientId: cid, redirectUri } });
              pca.handleRedirectPromise().then(async (resp) => {
                try {
                  const accounts = pca.getAllAccounts();
                  const account = resp?.account || (accounts && accounts[0]);
                  if (!account) {
                    window.opener?.postMessage({ type: 'msal_error', error: 'no_account' }, window.location.origin);
                    window.close();
                    return;
                  }
                  try {
                    const tokenResp = await pca.acquireTokenSilent({ scopes: ['User.Read'], account });
                    window.opener?.postMessage({ type: 'msal_auth', accessToken: tokenResp.accessToken }, window.location.origin);
                    window.close();
                    return;
                  } catch (e) {
                    try {
                      const popupResp = await pca.acquireTokenPopup({ scopes: ['User.Read'], account });
                      window.opener?.postMessage({ type: 'msal_auth', accessToken: popupResp.accessToken }, window.location.origin);
                      window.close();
                      return;
                    } catch (err2) {
                      window.opener?.postMessage({ type: 'msal_error', error: String(err2) }, window.location.origin);
                      window.close();
                      return;
                    }
                  }
                } catch (err) {
                  window.opener?.postMessage({ type: 'msal_error', error: String(err) }, window.location.origin);
                  window.close();
                }
              }).catch((err) => {
                window.opener?.postMessage({ type: 'msal_error', error: String(err) }, window.location.origin);
                window.close();
              });
            } catch (e) {
              window.opener?.postMessage({ type: 'msal_error', error: String(e) }, window.location.origin);
              try { window.close(); } catch(_){}
            }
          };

          if (clientId) {
            console.debug('[msal_redirect] using embedded clientId', clientId);
            initWithClientId(clientId);
            return;
          }

          // If clientId not available, request it from opener (main app)
          if (window.opener && window.opener !== window) {
            // listen for response
            const recv = (ev) => {
              try {
                console.debug('[msal_redirect] recv message', { origin: ev.origin, expectedOrigin: window.location.origin, data: ev.data });
                // Accept client id messages even if origin differs (debugging); log mismatches
                const d = ev.data || {};
                if (d.type === 'msal_client_id' && d.clientId) {
                  window.removeEventListener('message', recv);
                  initWithClientId(d.clientId);
                }
              } catch (e) { console.warn('[msal_redirect] recv handler error', e); }
            };
            window.addEventListener('message', recv);
            // request the client id; prefer specifying origin but fall back to wildcard for debugging
            try {
              try { window.opener.postMessage({ type: 'msal_request_client_id' }, window.location.origin); }
              catch (e) { window.opener.postMessage({ type: 'msal_request_client_id' }, '*'); }
            } catch (e) {
              console.warn('[msal_redirect] failed to request client id', e);
              try { window.opener.postMessage({ type: 'msal_error', error: 'missing_client_id' }, '*'); } catch (_) {}
              try { window.close(); } catch(_){ }
            }
            // timeout after 25s
            setTimeout(() => { try { window.removeEventListener('message', recv); } catch(_){}; try { window.close(); } catch(_){}; }, 25000);
          } else {
            try { window.opener?.postMessage({ type: 'msal_error', error: 'missing_client_id' }, '*'); } catch(_){}
            try { window.close(); } catch(_){ }
          }
        } catch (e) {
          try { window.opener?.postMessage({ type: 'msal_error', error: String(e) }, window.location.origin); } catch(_){}
          try { window.close(); } catch(_){}
        }
      })();
    </script>
  </body>
</html>
